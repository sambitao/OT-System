<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Tracker System</title>
    
    <!-- 1. ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ‡πÇ‡∏´‡∏•‡∏î React Library -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. ‡πÇ‡∏´‡∏•‡∏î Babel ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ UMD ‡∏Ç‡∏≠‡∏á lucide-react ‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡∏´‡∏≤ window.react (‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å) -->
    <script>
        window.react = window.React;
    </script>

    <!-- 4. ‡πÇ‡∏´‡∏•‡∏î ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (Lucide) ‡πÅ‡∏•‡∏∞ ExcelJS ‡πÅ‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ (0.260.0) -->
    <script src="https://unpkg.com/lucide@0.260.0"></script>
    <script src="https://unpkg.com/lucide-react@0.260.0/dist/umd/lucide-react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö -->
    <script type="text/babel" data-type="module">
        // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Firebase ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á Google
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≤‡∏Å React
        const { useState, useEffect } = React;
        
        // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (Safe Fallback) ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏•‡πà‡∏° 100%
        const L = window.lucideReact || window.LucideReact || {};
        const safeIcon = (iconName) => {
            return L[iconName] || ((props) => <span style={{display: 'inline-block', width: props.size || 24, height: props.size || 24, backgroundColor: '#cbd5e1', borderRadius: '50%'}} title={`Icon: ${iconName}`} />);
        };

        const Plus = safeIcon('Plus');
        const History = safeIcon('History');
        const LayoutDashboard = safeIcon('LayoutDashboard');
        const FileText = safeIcon('FileText');
        const Clock = safeIcon('Clock');
        const MapPin = safeIcon('MapPin');
        const Users = safeIcon('Users');
        const CheckCircle2 = L.CheckCircle2 || L.CircleCheck || safeIcon('CheckCircle');
        const Trash2 = safeIcon('Trash2');
        const Download = safeIcon('Download');
        const ImageIcon = safeIcon('Image');
        const Calendar = safeIcon('Calendar');
        const Search = safeIcon('Search');
        const ChevronRight = safeIcon('ChevronRight');
        const Filter = safeIcon('Filter');
        const Sparkles = safeIcon('Sparkles');
        const ClipboardPaste = safeIcon('ClipboardPaste');
        const X = safeIcon('X');
        const Eye = safeIcon('Eye');
        const Printer = safeIcon('Printer');
        const TableProperties = safeIcon('TableProperties');
        const Edit = safeIcon('Edit');
        const Upload = safeIcon('Upload');
        const Loader2 = safeIcon('Loader2');
        const Cloud = safeIcon('Cloud');
        const HardDrive = safeIcon('HardDrive');
        const LogOut = safeIcon('LogOut');
        const Lock = safeIcon('Lock');
        const UserIcon = safeIcon('User');
        const Key = safeIcon('Key');
        const Banknote = safeIcon('Banknote');

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyAZobmlUZjp1p8VREyu0Z1WBE70HkN5Upk",
            authDomain: "ot-system-8b149.firebaseapp.com",
            projectId: "ot-system-8b149",
            storageBucket: "ot-system-8b149.firebasestorage.app",
            messagingSenderId: "193470694347",
            appId: "1:193470694347:web:12fdaca46eeed77e5eac4e"
        };

        const APP_ID = 'ot-system-prod';
        
        // üåü ‡πÉ‡∏™‡πà Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
        const GAS_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbyvKG9pey53IFNXkk49ZwAtXPTJApW6cI6lJH6mJHDzvo0usUFQT_Z93kmlu1asXkz75A/exec';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (User Roles) ---
        const APP_USERS = {
            'admin':       { pass: 'admin1234', role: 'admin', filterName: 'admin', displayName: 'Administrator' },
            'arttapon.j':  { pass: 'arttapon.j1234', role: 'user', filterName: 'arttapon', displayName: 'Arttapon.J' },
            'kittipoom.p': { pass: 'kittipoom.p1234', role: 'user', filterName: 'kittipoom', displayName: 'Kittipoom.P' },
            'amnat.s':     { pass: 'amnat.s1234', role: 'user', filterName: 'amnat', displayName: 'Amnat.S' },
            'phanuwat.p':  { pass: 'phanuwat.p1234', role: 'user', filterName: 'phanuwat', displayName: 'Phanuwat.P' },
            'noppadol.m':  { pass: 'noppadol.m1234', role: 'user', filterName: 'noppadol', displayName: 'Noppadol.M' },
            'nattawut.p':  { pass: 'nattawut.p1234', role: 'user', filterName: 'nattawut', displayName: 'Nattawut.P' }
        };

        function App() {
            const [loggedInUser, setLoggedInUser] = useState(() => {
                const saved = localStorage.getItem('ot_user');
                return saved ? JSON.parse(saved) : null;
            });

            const [activeTab, setActiveTab] = useState('dashboard');
            const [records, setRecords] = useState([]);
            const [showForm, setShowForm] = useState(false);
            const [editingRecord, setEditingRecord] = useState(null);
            const [dashboardMonth, setDashboardMonth] = useState(''); 
            const [recordToDelete, setRecordToDelete] = useState(null); 
            const [showChangePassword, setShowChangePassword] = useState(false); 
            
            const [user, setUser] = useState(null);
            const [dbStatus, setDbStatus] = useState('connecting');

            const handleLogin = (userData) => {
                setLoggedInUser(userData);
                localStorage.setItem('ot_user', JSON.stringify(userData));
            };

            const handleLogout = () => {
                setLoggedInUser(null);
                localStorage.removeItem('ot_user');
                setRecords([]);
            };

            useEffect(() => {
                const initAuth = async () => {
                try {
                    await signInAnonymously(auth);
                } catch (err) {
                    setDbStatus('local_only'); 
                }
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
                setUser(currentUser);
                if(currentUser && dbStatus !== 'local_only') {
                    setDbStatus('connected');
                }
                });

                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user || dbStatus === 'local_only' || !loggedInUser) return;

                const recordsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'ot_records');
                
                const unsubscribeData = onSnapshot(recordsRef, (snapshot) => {
                    let data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (loggedInUser.role !== 'admin') {
                        data = data.filter(r => 
                        r.responsible && r.responsible.toLowerCase().includes(loggedInUser.filterName.toLowerCase())
                        );
                    }
                    
                    setRecords(data);
                    setDbStatus('connected');
                }, (error) => {
                    setDbStatus('local_only');
                });

                return () => unsubscribeData();
            }, [user, dbStatus, loggedInUser]);

            if (!loggedInUser) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            const getSortValue = (dateStr, createdAt) => {
                if (!dateStr) return new Date(createdAt).getTime();
                let d = new Date(dateStr);
                if (!isNaN(d.getTime())) return d.getTime();
                const cleanStr = dateStr.replace(/\s*-\s*\d+/g, '');
                d = new Date(cleanStr);
                if (!isNaN(d.getTime())) return d.getTime();
                return new Date(createdAt).getTime(); 
            };

            const sortedRecords = [...records].sort((a, b) => getSortValue(b.date, b.createdAt) - getSortValue(a.date, a.createdAt));

            const availableMonths = [...new Set(records.map(r => {
                const d = new Date(r.createdAt || Date.now());
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();

            const dashboardRecords = dashboardMonth 
                ? records.filter(r => {
                    const d = new Date(r.createdAt || Date.now());
                    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}` === dashboardMonth;
                })
                : records;

            const shortCount = dashboardRecords.filter(r => r.jobType?.includes('Short')).length;
            const mediumCount = dashboardRecords.filter(r => r.jobType?.includes('Medium')).length;
            const longCount = dashboardRecords.filter(r => r.jobType?.includes('Long')).length;

            const stats = {
                totalJobs: dashboardRecords.length,
                shortPeriod: shortCount,
                mediumPeriod: mediumCount,
                longPeriod: longCount,
                totalCost: (shortCount * 440) + (mediumCount * 660) + (longCount * 880) 
            };

            const handleSaveRecord = async (newRecord) => {
                setShowForm(false);
                setEditingRecord(null);
                setActiveTab('history');
                
                if (dbStatus === 'local_only' || !user) {
                    if (editingRecord) {
                        setRecords(records.map(r => r.id === editingRecord.id ? { ...newRecord, id: r.id, createdAt: r.createdAt } : r));
                    } else {
                        setRecords([{ ...newRecord, id: Date.now().toString(), createdAt: new Date().toISOString() }, ...records]);
                    }
                    return;
                }

                setDbStatus('connecting'); 
                const recordsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'ot_records');
                
                try {
                    if (editingRecord) {
                        const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'ot_records', editingRecord.id);
                        await updateDoc(docRef, { ...newRecord, updatedAt: new Date().toISOString() });
                    } else {
                        const newId = Date.now().toString();
                        const docRef = doc(recordsRef, newId);
                        await setDoc(docRef, { ...newRecord, createdAt: new Date().toISOString() });
                    }
                    setDbStatus('connected');
                } catch (err) {
                    setDbStatus('local_only');
                }
            };

            const handleEditRecord = (record) => {
                setEditingRecord(record);
                setShowForm(true);
            };

            const requestDelete = (id) => {
                setRecordToDelete(id);
            };

            const executeDelete = async () => {
                if (!recordToDelete) return;
                const id = recordToDelete;
                
                if (dbStatus === 'local_only' || !user) {
                    setRecords(records.filter(r => r.id !== id));
                    setRecordToDelete(null);
                    return;
                }

                setDbStatus('connecting');
                try {
                    const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'ot_records', id);
                    await deleteDoc(docRef);
                    setDbStatus('connected');
                } catch (err) {
                    setDbStatus('local_only');
                }
                setRecordToDelete(null);
            };

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row font-sans text-slate-900">
                <aside className="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 text-slate-800 p-6 sticky top-0 h-screen">
                    <div className="flex items-center gap-3 mb-10 px-2">
                    <div className="bg-orange-500 p-2 rounded-lg text-white shadow-md shadow-orange-500/20">
                        <Clock size={24} />
                    </div>
                    <div>
                        <h1 className="text-xl font-black tracking-tight text-slate-900">OT Tracker</h1>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{loggedInUser.role === 'admin' ? 'Admin Panel' : 'User Panel'}</p>
                    </div>
                    </div>
                    
                    <nav className="space-y-2 flex-1">
                    <NavItem active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutDashboard size={20} />} label="Dashboard" />
                    <NavItem active={activeTab === 'history'} onClick={() => setActiveTab('history')} icon={<History size={20} />} label="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" />
                    <NavItem active={activeTab === 'reports'} onClick={() => setActiveTab('reports')} icon={<FileText size={20} />} label="‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Export)" />
                    </nav>

                    <div className="mt-auto pt-6 border-t border-slate-100 space-y-3">
                    <button 
                        onClick={() => { setEditingRecord(null); setShowForm(true); }}
                        className="w-full flex items-center justify-center gap-2 bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-xl transition-all shadow-lg shadow-orange-500/30 font-bold"
                    >
                        <Plus size={20} />
                        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å OT ‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                    </div>
                </aside>

                <main className="flex-1 overflow-y-auto pb-20 md:pb-0">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                    <h2 className="text-lg font-bold text-slate-800">
                        {activeTab === 'dashboard' && '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö'}
                        {activeTab === 'history' && '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'}
                        {activeTab === 'reports' && '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Export)'}
                    </h2>
                    
                    <div className="flex items-center gap-4 text-slate-600">
                        <div className="hidden md:flex items-center">
                            {dbStatus === 'connected' ? (
                                <span className="flex items-center gap-1.5 text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-full border border-emerald-100">
                                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                    Online
                                </span>
                            ) : (
                                <span className="flex items-center gap-1.5 text-[10px] font-bold text-slate-600 bg-slate-100 px-2.5 py-1 rounded-full border border-slate-200">
                                    <HardDrive size={10} />
                                    Offline
                                </span>
                            )}
                        </div>
                        
                        <div className="w-px h-6 bg-slate-200 mx-1 hidden md:block"></div>
                        
                        <div className="flex items-center gap-3">
                            <div className="text-right hidden sm:block">
                                <div className="text-sm font-bold text-slate-800 leading-tight">{loggedInUser.displayName}</div>
                                <div className="text-[10px] font-medium text-slate-400 capitalize">{loggedInUser.role} Account</div>
                            </div>
                            <div className="w-9 h-9 rounded-full bg-orange-100 border border-orange-200 flex items-center justify-center text-orange-600 font-bold">
                                {loggedInUser.displayName.charAt(0)}
                            </div>
                            <button 
                            onClick={() => setShowChangePassword(true)}
                            title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
                            className="ml-4 p-2 text-slate-400 hover:text-orange-500 hover:bg-orange-50 rounded-full transition-colors"
                            >
                            <Key size={18} />
                            </button>
                            <button 
                            onClick={handleLogout}
                            title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"
                            className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                            >
                            <LogOut size={18} />
                            </button>
                        </div>
                    </div>
                    </header>

                    <div className="p-4 md:p-8 max-w-6xl mx-auto">
                    {activeTab === 'dashboard' && (
                        <Dashboard 
                            stats={stats} 
                            recentRecords={sortedRecords.slice(0, 3)} 
                            onSetTab={setActiveTab} 
                            selectedMonth={dashboardMonth}
                            setSelectedMonth={setDashboardMonth}
                            availableMonths={availableMonths}
                            dbStatus={dbStatus}
                        />
                    )}
                    {activeTab === 'history' && <HistoryList records={sortedRecords} onDelete={requestDelete} onEdit={handleEditRecord} />}
                    {activeTab === 'reports' && <Reports records={records} getSortValue={getSortValue} />}
                    </div>
                </main>

                <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center p-3 z-20">
                    <MobileNavItem active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon={<LayoutDashboard size={20} />} label="Home" />
                    <MobileNavItem active={activeTab === 'history'} onClick={() => setActiveTab('history')} icon={<History size={20} />} label="History" />
                    <div className="relative -top-6">
                    <button 
                        onClick={() => { setEditingRecord(null); setShowForm(true); }}
                        className="bg-orange-500 text-white p-4 rounded-full shadow-lg shadow-orange-500/30 border-4 border-slate-50"
                        >
                        <Plus size={24} />
                    </button>
                    </div>
                    <MobileNavItem active={activeTab === 'reports'} onClick={() => setActiveTab('reports')} icon={<FileText size={20} />} label="Report" />
                </nav>

                {showForm && (
                    <OTForm 
                        onSave={handleSaveRecord} 
                        onClose={() => { setShowForm(false); setEditingRecord(null); }} 
                        initialData={editingRecord}
                        loggedInUser={loggedInUser} 
                    />
                )}

                {showChangePassword && (
                    <ChangePasswordModal 
                    user={loggedInUser} 
                    onClose={() => setShowChangePassword(false)} 
                    onSuccess={(newUserData) => {
                        handleLogin(newUserData);
                        setShowChangePassword(false);
                    }}
                    />
                )}

                {recordToDelete && (
                    <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setRecordToDelete(null)}></div>
                    <div className="relative bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 text-center border border-slate-200 animate-in zoom-in-95 duration-200">
                        <div className="w-20 h-20 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-5 border-[6px] border-white shadow-sm">
                        <Trash2 size={36} />
                        </div>
                        <h3 className="text-xl font-black text-slate-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?</h3>
                        <p className="text-sm text-slate-500 mb-8 font-medium px-4">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å</p>
                        <div className="flex gap-3">
                        <button 
                            onClick={() => setRecordToDelete(null)}
                            className="flex-1 px-4 py-3.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition-colors"
                        >
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                        <button 
                            onClick={executeDelete}
                            className="flex-1 px-4 py-3.5 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 shadow-lg shadow-red-500/30 transition-all"
                        >
                            ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        </div>
                    </div>
                    </div>
                )}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoggingIn, setIsLoggingIn] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoggingIn(true);
                
                const userKey = username.trim().toLowerCase();
                const defaultUser = APP_USERS[userKey];

                if (!defaultUser) {
                setError('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                setIsLoggingIn(false);
                return;
                }

                try {
                const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'user_credentials', userKey);
                const docSnap = await getDoc(docRef);
                
                let currentPassword = defaultUser.pass; 
                if (docSnap.exists()) {
                    currentPassword = docSnap.data().password; 
                }

                if (password === currentPassword) {
                    onLogin({ username: userKey, ...defaultUser, currentPass: currentPassword });
                } else {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
                } catch (err) {
                if (password === defaultUser.pass) {
                    onLogin({ username: userKey, ...defaultUser, currentPass: defaultUser.pass });
                } else {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö Offline)');
                }
                }
                
                setIsLoggingIn(false);
            };

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl border border-slate-100 p-8 sm:p-10 animate-in fade-in zoom-in-95 duration-500">
                    <div className="text-center mb-10">
                    <div className="w-20 h-20 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm border border-orange-100">
                        <Lock size={36} />
                    </div>
                    <h1 className="text-2xl font-black text-slate-800 mb-2 tracking-tight">OT Tracker System</h1>
                    <p className="text-slate-500 text-sm font-medium">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</p>
                    </div>

                    <form onSubmit={handleSubmit} className="space-y-5">
                    {error && (
                        <div className="bg-red-50 text-red-600 text-sm font-bold p-4 rounded-xl text-center border border-red-100">
                        {error}
                        </div>
                    )}
                    
                    <div className="space-y-2">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Username</label>
                        <div className="relative">
                        <UserIcon className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                        <input 
                            type="text" 
                            autoComplete="off"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô arttapon.j"
                            className="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium focus:outline-none focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all"
                            value={username}
                            onChange={e => setUsername(e.target.value)}
                        />
                        </div>
                    </div>

                    <div className="space-y-2">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Password</label>
                        <div className="relative">
                        <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                        <input 
                            type="password" 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            className="w-full pl-11 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium focus:outline-none focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all"
                            value={password}
                            onChange={e => setPassword(e.target.value)}
                        />
                        </div>
                    </div>

                    <button 
                        type="submit"
                        disabled={isLoggingIn}
                        className="w-full py-4 bg-orange-500 text-white rounded-xl font-bold text-lg hover:bg-orange-600 shadow-lg shadow-orange-500/30 transition-all mt-4 flex justify-center items-center gap-2 disabled:bg-slate-300 disabled:shadow-none"
                    >
                        {isLoggingIn ? <Loader2 size={24} className="animate-spin" /> : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
                    </button>
                    </form>
                </div>
                </div>
            );
        }

        function ChangePasswordModal({ user, onClose, onSuccess }) {
            const [oldPass, setOldPass] = useState('');
            const [newPass, setNewPass] = useState('');
            const [confirmPass, setConfirmPass] = useState('');
            const [error, setError] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');

                if (oldPass !== user.currentPass) {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                if (newPass.length < 6) {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                    return;
                }
                if (newPass !== confirmPass) {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                    return;
                }
                if (newPass === oldPass) {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°');
                    return;
                }

                setIsSaving(true);
                try {
                    const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'user_credentials', user.username);
                    await setDoc(docRef, { password: newPass, updatedAt: new Date().toISOString() }, { merge: true });
                    
                    onSuccess({ ...user, currentPass: newPass });
                } catch (err) {
                    setError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                }
                setIsSaving(false);
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative bg-white w-full max-w-sm rounded-3xl shadow-2xl p-8 border border-slate-200 animate-in zoom-in-95 duration-200">
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center">
                                    <Key size={20} />
                                </div>
                                <h3 className="text-xl font-bold text-slate-800">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 bg-slate-100 p-2 rounded-full transition-colors">
                                <X size={16} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {error && (
                                <div className="bg-red-50 text-red-600 text-xs font-bold p-3 rounded-xl border border-red-100 text-center">
                                    {error}
                                </div>
                            )}
                            
                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-slate-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                <input 
                                    type="password" 
                                    required
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors text-sm font-medium"
                                    value={oldPass}
                                    onChange={e => setOldPass(e.target.value)}
                                />
                            </div>
                            
                            <div className="space-y-1.5 pt-2">
                                <label className="text-xs font-bold text-slate-500 uppercase">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)</label>
                                <input 
                                    type="password" 
                                    required
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors text-sm font-medium"
                                    value={newPass}
                                    onChange={e => setNewPass(e.target.value)}
                                />
                            </div>

                            <div className="space-y-1.5">
                                <label className="text-xs font-bold text-slate-500 uppercase">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                                <input 
                                    type="password" 
                                    required
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors text-sm font-medium"
                                    value={confirmPass}
                                    onChange={e => setConfirmPass(e.target.value)}
                                />
                            </div>

                            <button 
                                type="submit"
                                disabled={isSaving}
                                className="w-full py-3.5 bg-orange-500 text-white rounded-xl font-bold hover:bg-orange-600 shadow-lg shadow-orange-500/30 transition-all mt-6 flex justify-center items-center gap-2 disabled:bg-slate-300"
                            >
                                {isSaving ? <Loader2 size={18} className="animate-spin" /> : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function NavItem({ active, icon, label, onClick }) {
            return (
                <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${
                    active ? 'bg-orange-500 text-white shadow-md shadow-orange-500/20 font-semibold' : 'text-slate-500 hover:text-orange-600 hover:bg-orange-50 font-medium'
                }`}
                >
                {icon}
                <span className="text-sm">{label}</span>
                </button>
            );
        }

        function MobileNavItem({ active, icon, label, onClick }) {
            return (
                <button onClick={onClick} className={`flex flex-col items-center gap-1 ${active ? 'text-orange-500' : 'text-slate-400'}`}>
                {icon}
                <span className="text-[10px] font-bold">{label}</span>
                </button>
            );
        }

        function Dashboard({ stats, recentRecords, onSetTab, selectedMonth, setSelectedMonth, availableMonths, dbStatus }) {
            const formatMonth = (YYYYMM) => {
                const [year, month] = YYYYMM.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
            };

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                
                {/* üåü ‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° */}
                <div className="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-6 md:p-8 text-white shadow-xl shadow-emerald-500/20 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h3 className="text-emerald-100 font-bold uppercase tracking-widest text-xs md:text-sm mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)</h3>
                        <div className="flex items-baseline gap-2">
                            <span className="text-3xl md:text-5xl font-black tracking-tighter">‡∏ø {stats.totalCost.toLocaleString('th-TH')}</span>
                            <span className="text-emerald-200 font-medium text-sm md:text-base">‡∏ö‡∏≤‡∏ó</span>
                        </div>
                    </div>
                    <div className="hidden md:flex w-20 h-20 bg-white/20 rounded-full items-center justify-center backdrop-blur-md">
                        <Banknote size={40} className="text-white" />
                    </div>
                </div>

                <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div>
                    <h3 className="font-bold text-slate-800">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</h3>
                    <p className="text-xs text-slate-500">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏é‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                    </div>
                    <select 
                        value={selectedMonth}
                        onChange={e => setSelectedMonth(e.target.value)}
                        className="bg-slate-50 border border-slate-200 text-slate-700 font-medium py-2 px-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all cursor-pointer min-w-[200px]"
                    >
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Time)</option>
                        {availableMonths.map(m => (
                            <option key={m} value={m}>{formatMonth(m)}</option>
                        ))}
                    </select>
                </div>

                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <StatCard label="‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" value={stats.totalJobs} color="orange" icon={<FileText size={20} />} />
                    <StatCard label="Short (440.-)" value={stats.shortPeriod} color="green" icon={<Clock size={20} />} />
                    <StatCard label="Medium (660.-)" value={stats.mediumPeriod} color="blue" icon={<Clock size={20} />} />
                    <StatCard label="Long (880.-)" value={stats.longPeriod} color="purple" icon={<Clock size={20} />} />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2 space-y-4">
                    <div className="flex items-center justify-between">
                        <h3 className="text-lg font-bold text-slate-800">‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <button onClick={() => onSetTab('history')} className="text-orange-500 text-sm font-bold hover:underline flex items-center gap-1">
                        ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <ChevronRight size={16} />
                        </button>
                    </div>
                    <div className="space-y-3">
                        {recentRecords.length > 0 ? (
                        recentRecords.map(record => (
                            <div key={record.id} className="bg-white p-4 rounded-xl border border-slate-200 flex items-center justify-between shadow-sm hover:border-orange-200 transition-colors">
                            <div className="flex items-center gap-4">
                                <div className={`p-3 rounded-lg ${
                                record.jobType?.includes('Long') ? 'bg-purple-50 text-purple-600' : 'bg-orange-50 text-orange-500'
                                }`}>
                                <FileText size={24} />
                                </div>
                                <div>
                                <h4 className="font-bold text-slate-800 line-clamp-1">{record.interruption}</h4>
                                <p className="text-xs text-slate-500 flex items-center gap-1 mt-1 font-medium">
                                    <MapPin size={12} /> {record.location} | {record.date}
                                </p>
                                </div>
                            </div>
                            <div className="hidden sm:block text-right">
                                <span className="px-2 py-1 rounded-full bg-slate-50 text-[10px] font-bold text-slate-600 border border-slate-100 uppercase">
                                {record.jobType}
                                </span>
                            </div>
                            </div>
                        ))
                        ) : (
                        <div className="bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl p-12 text-center text-slate-400 font-medium">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </div>
                        )}
                    </div>
                    </div>

                    <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white flex flex-col justify-between shadow-xl shadow-orange-500/20">
                    <div>
                        <h3 className="text-xl font-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏ô Cloud</h3>
                        {dbStatus === 'local_only' ? (
                        <div className="bg-white/10 p-3 rounded-xl mt-3 border border-orange-300/50">
                            <p className="text-xs font-bold text-white uppercase tracking-wider mb-1 flex items-center gap-1"><HardDrive size={12}/> ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                            <p className="text-xs text-orange-50 opacity-90 leading-relaxed">
                            ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Cloud ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á
                            </p>
                        </div>
                        ) : (
                        <p className="text-orange-100 text-sm opacity-90 leading-relaxed font-medium">
                            ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE Bot ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        </p>
                        )}
                    </div>
                    <div className="mt-6 flex gap-2">
                        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border ${dbStatus === 'connected' ? 'bg-orange-700/50 border-orange-400/30' : 'bg-slate-700/50 border-slate-400/50'}`}>
                            <Cloud size={16} className={dbStatus === 'connected' ? "text-orange-200" : "text-white"} />
                            <span className="text-xs text-white font-bold">{dbStatus === 'connected' ? 'Cloud Sync Active' : 'Offline / Sandbox Mode'}</span>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            );
        }

        function StatCard({ label, value, color, icon }) {
            const colors = {
                orange: 'bg-orange-50 text-orange-500',
                green: 'bg-emerald-50 text-emerald-500',
                blue: 'bg-blue-50 text-blue-500',
                purple: 'bg-purple-50 text-purple-500',
            };
            return (
                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden">
                <div className={`w-10 h-10 rounded-xl ${colors[color]} flex items-center justify-center relative z-10`}>
                    {icon}
                </div>
                <div className="relative z-10">
                    <div className="text-2xl font-black text-slate-800">{value}</div>
                    <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">{label}</div>
                </div>
                </div>
            );
        }

        function HistoryList({ records, onDelete, onEdit }) {
            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                <div className="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                    <div className="relative w-full md:w-64">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                    <input 
                        type="text" 
                        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." 
                        className="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all font-medium"
                    />
                    </div>
                    <div className="flex items-center gap-2">
                    <button className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 hover:text-orange-500 transition-colors">
                        <Filter size={14} /> ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    </button>
                    </div>
                </div>

                <div className="overflow-hidden bg-white border border-slate-200 rounded-2xl shadow-sm">
                    <div className="overflow-x-auto">
                    <table className="w-full text-left text-sm">
                        <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-[10px] font-black tracking-widest">
                        <tr>
                            <th className="px-6 py-4">Job Info</th>
                            <th className="px-6 py-4">Date & Time</th>
                            <th className="px-6 py-4">Responsible</th>
                            <th className="px-6 py-4 text-center">Images</th>
                            <th className="px-6 py-4 text-right">Action</th>
                        </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                        {records.map((record) => {
                            const hasBothImages = record.beforeImage && record.afterImage;
                            const hasOneImage = record.beforeImage || record.afterImage;

                            return (
                            <tr key={record.id} className="hover:bg-orange-50/50 transition-colors">
                                <td className="px-6 py-4">
                                <div className="font-bold text-slate-800 line-clamp-1">{record.interruption}</div>
                                <div className="text-[10px] text-slate-500 flex items-center gap-2 mt-1">
                                    <span className="px-1.5 py-0.5 bg-slate-100 border border-slate-200 rounded uppercase font-bold text-slate-600">{record.jobType?.split('(')[1]?.replace(')', '') || record.jobType}</span>
                                    <span className="font-medium">ID: {record.interruptionId || '-'}</span>
                                </div>
                                </td>
                                <td className="px-6 py-4">
                                <div className="text-slate-700 font-bold">{record.date}</div>
                                <div className="text-xs text-slate-400 font-medium">{record.time}</div>
                                </td>
                                <td className="px-6 py-4">
                                <div className="flex items-center gap-2">
                                    <Users size={14} className="text-slate-400" />
                                    <span className="text-slate-600 font-medium truncate max-w-[150px]">{record.responsible}</span>
                                </div>
                                </td>
                                <td className="px-6 py-4 text-center">
                                {hasBothImages ? (
                                    <span className="inline-flex items-center gap-1 text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-full text-[10px] font-bold border border-emerald-100">
                                    <CheckCircle2 size={10} /> ‡∏£‡∏π‡∏õ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
                                    </span>
                                ) : hasOneImage ? (
                                    <span className="inline-flex items-center gap-1 text-orange-600 bg-orange-50 px-2.5 py-1 rounded-full text-[10px] font-bold border border-orange-100">
                                    <ImageIcon size={10} /> ‡∏Ç‡∏≤‡∏î 1 ‡∏£‡∏π‡∏õ
                                    </span>
                                ) : (
                                    <span className="inline-flex items-center gap-1 text-red-600 bg-red-50 px-2.5 py-1 rounded-full text-[10px] font-bold border border-red-100">
                                    <ImageIcon size={10} /> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ
                                    </span>
                                )}
                                </td>
                                <td className="px-6 py-4 text-right">
                                <div className="flex justify-end gap-3">
                                    <button 
                                    onClick={() => onEdit(record)}
                                    className="text-slate-400 hover:text-orange-500 transition-colors"
                                    title="‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                    >
                                    <Edit size={18} />
                                    </button>
                                    <button 
                                    onClick={() => onDelete(record.id)}
                                    className="text-slate-400 hover:text-red-500 transition-colors"
                                    title="‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                                    >
                                    <Trash2 size={18} />
                                    </button>
                                </div>
                                </td>
                            </tr>
                            );
                        })}
                        {records.length === 0 && (
                            <tr>
                            <td colSpan="5" className="px-6 py-12 text-center text-slate-400 italic font-medium">
                                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                            </td>
                            </tr>
                        )}
                        </tbody>
                    </table>
                    </div>
                </div>
                </div>
            );
        }

        function Reports({ records, getSortValue }) {
            const [showPreview, setShowPreview] = useState(false);
            const [isExportingExcel, setIsExportingExcel] = useState(false);
            const [exportProgress, setExportProgress] = useState('');

            const handleExportExcel = async () => {
                setIsExportingExcel(true);
                setExportProgress('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...');
                try {
                    const workbook = new window.ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('OT Report');
                    
                    worksheet.columns = [
                        { width: 5 },
                        { width: 20 },
                        { width: 45 },
                        { width: 25 },
                        { width: 25 }
                    ];

                    worksheet.mergeCells('A1:E1');
                    const titleCell = worksheet.getCell('A1');
                    titleCell.value = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (OT )';
                    titleCell.font = { name: 'Tahoma', size: 14, bold: true };
                    titleCell.alignment = { vertical: 'middle', horizontal: 'left' };
                    
                    const fetchImageBase64 = async (url) => {
                        if (!url) return null;
                        if (url.startsWith('data:image')) return url; 
                        
                        try {
                            const urlObj = new URL(url);
                            const fileId = urlObj.searchParams.get('id');
                            if (!fileId) return null;

                            const response = await fetch(GAS_WEBHOOK_URL, {
                                method: 'POST',
                                body: JSON.stringify({ action: 'get_image', fileId: fileId }),
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                            });
                            const result = await response.json();
                            if (result.success) return result.base64;
                        } catch (e) {
                            console.error("Image proxy failed", e);
                        }
                        return null;
                    };

                    let currentRow = 2;
                    const sortedRecords = [...records].sort((a, b) => getSortValue(a.date, a.createdAt) - getSortValue(b.date, b.createdAt)); 
                    
                    for (let index = 0; index < sortedRecords.length; index++) {
                        const record = sortedRecords[index];
                        setExportProgress(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${index + 1}/${sortedRecords.length}...`);
                        const i = index + 1;
                        
                        worksheet.addRow([i, 'JOB Type :', record.jobType, '‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥', '‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥']);
                        worksheet.addRow(['', 'Interruption :', record.interruption, '', '']);
                        worksheet.addRow(['', 'Interruption ID :', record.interruptionId || '-', '', '']);
                        worksheet.addRow(['', 'Reason', record.reason || '-', '', '']);
                        worksheet.addRow(['', 'Location :', 'Location: ' + record.location, '', '']);
                        worksheet.addRow(['', 'Date :', 'Date: ' + record.date, '', '']);
                        worksheet.addRow(['', 'Time :', 'Time: ' + record.time, '', '']);
                        worksheet.addRow(['', 'NSB Responsible :', '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô : ' + record.responsible, '', '']);
                        
                        worksheet.mergeCells(`A${currentRow}:A${currentRow+7}`);
                        worksheet.mergeCells(`D${currentRow+1}:D${currentRow+7}`);
                        worksheet.mergeCells(`E${currentRow+1}:E${currentRow+7}`);
                        
                        for (let r = currentRow; r <= currentRow + 7; r++) {
                            const row = worksheet.getRow(r);
                            row.height = 18; 
                            row.eachCell({ includeEmpty: true }, (cell) => {
                                cell.font = { name: 'Tahoma', size: 10 };
                                cell.border = {
                                    top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
                                };
                                cell.alignment = { vertical: 'top', wrapText: true };
                            });
                        }
                        
                        worksheet.getCell(`A${currentRow}`).alignment = { vertical: 'middle', horizontal: 'center' };
                        worksheet.getCell(`A${currentRow}`).font = { name: 'Tahoma', size: 10, bold: true };
                        worksheet.getCell(`B${currentRow}`).font = { name: 'Tahoma', size: 10, bold: true };
                        worksheet.getCell(`C${currentRow}`).font = { name: 'Tahoma', size: 10, bold: true, color: { argb: 'FFEA580C' } }; 
                        worksheet.getCell(`D${currentRow}`).font = { name: 'Tahoma', size: 10, bold: true };
                        worksheet.getCell(`D${currentRow}`).alignment = { horizontal: 'center' };
                        worksheet.getCell(`E${currentRow}`).font = { name: 'Tahoma', size: 10, bold: true };
                        worksheet.getCell(`E${currentRow}`).alignment = { horizontal: 'center' };
                        
                        const addImageToCell = async (imageUrl, colIndex0Based, currentR) => {
                            const base64String = await fetchImageBase64(imageUrl);
                            if (!base64String) return;
                            
                            const extMatch = base64String.match(/^data:image\/([a-zA-Z0-9]+);base64,/);
                            const ext = extMatch ? extMatch[1] : 'png';
                            const base64Data = base64String.replace(/^data:image\/[a-zA-Z0-9]+;base64,/, '');
                            const imgId = workbook.addImage({ base64: base64Data, extension: ext });
                            
                            worksheet.addImage(imgId, {
                                tl: { col: colIndex0Based, row: currentR }, 
                                br: { col: colIndex0Based + 1, row: currentR + 7 }, 
                                editAs: 'twoCell'
                            });
                        };

                        if (record.beforeImage) await addImageToCell(record.beforeImage, 3, currentRow);
                        if (record.afterImage) await addImageToCell(record.afterImage, 4, currentRow);
                        
                        currentRow += 8;
                        worksheet.addRow([]); 
                        currentRow += 1;
                    }
                    
                    setExportProgress('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel...');
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `OT_Report_${new Date().toLocaleString('default', { month: 'short', year: 'numeric' })}.xlsx`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (error) {
                    console.error("Excel generation error:", error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel');
                } finally {
                    setIsExportingExcel(false);
                    setExportProgress('');
                }
            };

            return (
                <div className="space-y-6 animate-in fade-in duration-500">
                <div className="bg-white rounded-2xl border border-slate-200 p-8 text-center space-y-6 shadow-sm">
                    <div className="w-16 h-16 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mx-auto">
                    <TableProperties size={32} />
                    </div>
                    <div className="space-y-2">
                        <h3 className="text-xl font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Export Center)</h3>
                        <p className="text-slate-500 max-w-sm mx-auto text-sm font-medium">
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        </p>
                    </div>
                    
                    <div className="flex flex-col sm:flex-row gap-3 justify-center pt-2">
                    <button 
                        onClick={() => setShowPreview(true)}
                        className="flex items-center justify-center gap-2 px-6 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-orange-50 hover:text-orange-600 hover:border-orange-200 transition-all shadow-sm"
                    >
                        <Eye size={20} /> ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß & ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    </button>
                    </div>
                    
                    {records.length === 0 && (
                        <p className="text-xs text-orange-500 font-bold">! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>
                    )}
                </div>

                {showPreview && (
                    <ReportPreviewModal 
                        records={records} 
                        getSortValue={getSortValue}
                        onClose={() => setShowPreview(false)} 
                        onExportExcel={handleExportExcel}
                        isExportingExcel={isExportingExcel} 
                        exportProgress={exportProgress}
                    />
                )}
                </div>
            );
        }

        function ReportPreviewModal({ records, getSortValue, onClose, onExportExcel, isExportingExcel, exportProgress }) {
            const [isPrinting, setIsPrinting] = useState(false);

            const handlePrint = () => {
                setIsPrinting(true);
                const printContent = document.getElementById('report-print-area').innerHTML;
                
                const iframe = document.createElement('iframe');
                iframe.style.visibility = 'hidden';
                iframe.style.position = 'absolute';
                iframe.style.width = '0px';
                iframe.style.height = '0px';
                iframe.style.border = 'none';
                document.body.appendChild(iframe);
                
                const docWindow = iframe.contentWindow.document;
                docWindow.open();
                
                // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏ó‡πá‡∏Å script ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å string
                docWindow.write(`
                    <!DOCTYPE html>
                    <html>
                        <head>
                            <title>OT_Report_${new Date().toLocaleDateString('en-GB').replace(/\//g, '-')}</title>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            <style>
                                @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap');
                                body { font-family: 'Tahoma', 'Sarabun', sans-serif; line-height: 1.5; color: #1e293b; background: white; }
                                @media print {
                                    @page { size: A4 portrait; margin: 10mm; }
                                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                    tbody { page-break-inside: avoid !important; }
                                }
                            </style>
                        </head>
                        <body>
                            <div style="width: 100%; max-width: 210mm; margin: 0 auto; padding: 0;">
                                ${printContent}
                            </div>
                            <script>
                                window.onload = function() {
                                    setTimeout(function() {
                                        window.focus();
                                        window.print();
                                    }, 800);
                                };
                            <\/script>
                        </body>
                    </html>
                `);
                docWindow.close();
                setTimeout(() => { setIsPrinting(false); }, 1500);
                setTimeout(() => { if (document.body.contains(iframe)) document.body.removeChild(iframe); }, 300000); 
            };

            const sortedRecords = [...records].sort((a, b) => getSortValue(a.date, a.createdAt) - getSortValue(b.date, b.createdAt));

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-0 md:p-6 overflow-hidden">
                    <div className="absolute inset-0 bg-slate-900/70 backdrop-blur-md" onClick={onClose}></div>
                    <div className="relative bg-white w-full max-w-5xl h-full md:h-[95vh] md:rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-in zoom-in-95 duration-200 border border-slate-200">
                        <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-white">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-orange-50 text-orange-500 rounded-lg">
                                    <TableProperties size={20} />
                                </div>
                                <h3 className="font-bold text-slate-800">‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô Export</h3>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={onClose} className="p-2 text-slate-400 hover:text-slate-600 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                                    <X size={20} />
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto bg-slate-100 p-4">
                            <div 
                            id="report-print-area" 
                            className="bg-white w-full max-w-[210mm] mx-auto p-4 md:p-8 shadow-sm border border-slate-200 min-h-full"
                            style={{ fontFamily: "'Tahoma', 'Sarabun', sans-serif", lineHeight: '1.5' }} 
                            >
                                <table className="w-full table-fixed border-collapse border border-slate-400 text-[12px] text-slate-800 leading-relaxed">
                                    <colgroup>
                                        <col style={{ width: '5%' }} />
                                        <col style={{ width: '18%' }} />
                                        <col style={{ width: '37%' }} />
                                        <col style={{ width: '20%' }} />
                                        <col style={{ width: '20%' }} />
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <td colSpan="5" className="font-bold text-[16px] pb-4 border-none px-2 text-center md:text-left">
                                                ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (OT )
                                            </td>
                                        </tr>
                                    </thead>
                                    
                                    {sortedRecords.length > 0 ? sortedRecords.map((record, index) => {
                                        const i = index + 1;
                                        return (
                                            <tbody key={record.id}>
                                                <tr className="bg-slate-50">
                                                    <td className="border border-slate-400 p-1.5 text-center align-middle font-bold" rowSpan="8">{i}</td>
                                                    <td className="border border-slate-400 p-1.5 font-bold">JOB Type :</td>
                                                    <td className="border border-slate-400 p-1.5 font-semibold text-orange-600 break-words">{record.jobType}</td>
                                                    <td className="border border-slate-400 p-1.5 text-center font-bold">‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥</td>
                                                    <td className="border border-slate-400 p-1.5 text-center font-bold">‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥</td>
                                                </tr>
                                                <tr>
                                                    <td className="border border-slate-400 p-1.5 font-bold whitespace-nowrap">Interruption :</td>
                                                    <td className="border border-slate-400 p-1.5 break-words whitespace-pre-wrap">{record.interruption}</td>
                                                    <td className="border border-slate-400 p-1 text-center align-middle" rowSpan="7">
                                                        {record.beforeImage ? (
                                                            <div className="flex justify-center items-center h-full min-h-[90px]">
                                                                <img src={record.beforeImage} alt="Before" className="max-h-[110px] max-w-full object-contain rounded-sm" />
                                                            </div>
                                                        ) : (
                                                            <div className="flex flex-col items-center justify-center text-slate-300 min-h-[90px]">
                                                                <ImageIcon size={20} className="mb-1 opacity-50"/>
                                                                <span className="text-[9px] font-bold tracking-widest uppercase">Insert Image</span>
                                                            </div>
                                                        )}
                                                    </td>
                                                    <td className="border border-slate-400 p-1 text-center align-middle" rowSpan="7">
                                                        {record.afterImage ? (
                                                            <div className="flex justify-center items-center h-full min-h-[90px]">
                                                                <img src={record.afterImage} alt="After" className="max-h-[110px] max-w-full object-contain rounded-sm" />
                                                            </div>
                                                        ) : (
                                                            <div className="flex flex-col items-center justify-center text-slate-300 min-h-[90px]">
                                                                <ImageIcon size={20} className="mb-1 opacity-50"/>
                                                                <span className="text-[9px] font-bold tracking-widest uppercase">Insert Image</span>
                                                            </div>
                                                        )}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td className="border border-slate-400 p-1.5 font-bold">Interruption ID :</td>
                                                    <td className="border border-slate-400 p-1.5 break-words">{record.interruptionId || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <td className="border border-slate-400 p-1.5 font-bold">Reason</td>
                                                    <td className="border border-slate-400 p-1.5 break-words">{record.reason || '-'}</td>
                                                </tr>
                                                <tr>
                                                    <td className="border border-slate-400 p-1.5 font-bold">Location :</td>
                                                    <td className="border border-slate-400 p-1.5 break-words">Location: {record.location}</td>
                                                </tr>
                                                <tr>
                                                    <td className="border border-slate-400 p-1.5 font-bold">Date :</td>
                                                    <td className="border border-slate-400 p-1.5 break-words">Date: {record.date}</td>
                                                </tr>
                                                <tr>
                                                    <td className="border border-slate-400 p-1.5 font-bold">Time :</td>
                                                    <td className="border border-slate-400 p-1.5 break-words">Time: {record.time}</td>
                                                </tr>
                                                <tr>
                                                    <td className="border border-slate-400 p-1.5 font-bold">NSB Responsible :</td>
                                                    <td className="border border-slate-400 p-1.5 break-words">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô : {record.responsible}</td>
                                                </tr>
                                                <tr>
                                                    <td colSpan="5" className="h-3 border-none"></td>
                                                </tr>
                                            </tbody>
                                        )
                                    }) : (
                                        <tbody>
                                            <tr>
                                                <td colSpan="5" className="p-10 text-center text-slate-400 border border-dashed border-slate-300">
                                                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
                                                </td>
                                            </tr>
                                        </tbody>
                                    )}
                                </table>
                            </div>
                        </div>

                        <div className="p-4 border-t border-slate-100 flex flex-wrap justify-end gap-3 bg-white">
                            <button 
                                onClick={onClose}
                                className="px-6 py-2.5 text-slate-600 font-bold hover:bg-slate-50 rounded-xl transition-all"
                            >
                                ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                            </button>
                            <button 
                                onClick={onExportExcel}
                                disabled={records.length === 0 || isExportingExcel || isPrinting}
                                className="flex items-center gap-2 px-6 py-2.5 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-100 disabled:opacity-50"
                            >
                                {isExportingExcel ? <><Loader2 size={18} className="animate-spin" /> {exportProgress}</> : <><Download size={18} /> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel (.xlsx)</>} 
                            </button>
                            <button 
                                onClick={handlePrint}
                                disabled={records.length === 0 || isExportingExcel || isPrinting}
                                className="flex items-center gap-2 px-6 py-2.5 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-600 transition-all shadow-lg shadow-orange-500/30 disabled:opacity-50"
                            >
                                {isPrinting ? <Loader2 size={18} className="animate-spin" /> : <Printer size={18} />}
                                Print / Save as PDF
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function OTForm({ onSave, onClose, initialData, loggedInUser }) {
            const [isSmartPaste, setIsSmartPaste] = useState(false);
            const [isExtracting, setIsExtracting] = useState(false);
            const [rawText, setRawText] = useState('');
            const [uploadingState, setUploadingState] = useState({ beforeImage: false, afterImage: false });
            
            const defaultResponsible = loggedInUser?.role === 'admin' ? '' : (loggedInUser?.displayName || '');

            const [formData, setFormData] = useState(initialData || {
                jobType: 'Interruption (Short Period)',
                interruption: '',
                interruptionId: '',
                reason: '',
                location: '',
                date: new Date().toISOString().split('T')[0],
                time: '18:00 - 21:00',
                responsible: defaultResponsible,
                duration: '3',
                beforeImage: null,
                afterImage: null
            });

            const calculateJobType = (hours) => {
                const h = parseFloat(hours);
                if (h >= 7) return 'Interruption (Long Period)';
                if (h >= 5) return 'Interruption (Medium Period)';
                return 'Interruption (Short Period)';
            };

            useEffect(() => {
                const newType = calculateJobType(formData.duration);
                if (newType !== formData.jobType) {
                setFormData(prev => ({ ...prev, jobType: newType }));
                }
            }, [formData.duration]);

            const handleSmartPaste = async () => {
                if (!rawText.trim()) return;
                setIsExtracting(true);

                const cleanText = rawText
                .replace(/[\u200B-\u200F\u2028\u2029\u202A-\u202E\u2060-\u206F\uFEFF]/g, '')
                .replace(/Ôºö/g, ':');

                const extractFallback = (keywordsRegex) => {
                const match = cleanText.match(keywordsRegex);
                return match ? match[1].trim() : '';
                };

                // üåü ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏Å‡∏±‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô')
                let newInterruption = extractFallback(/(?:Interruption|‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô|‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô|‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)\s*[:=]\s*(.*)/i);
                
                if (!newInterruption) {
                    const matchJob = cleanText.match(/‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô\s*[:=]?\s*([\s\S]*?)(?=\n(?:Location|‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà|Date|‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà|Time|‡πÄ‡∏ß‡∏•‡∏≤|‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà|‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô|Interruption ID|ID|‡∏£‡∏´‡∏±‡∏™|Reason|‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)|$)/i);
                    if (matchJob) {
                        newInterruption = matchJob[1].trim().replace(/\n/g, ' ');
                    }
                }

                const newId = extractFallback(/(?:Interruption ID|ID|‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô|‡∏£‡∏´‡∏±‡∏™)\s*[:=]\s*(.*)/i);
                const newReason = extractFallback(/(?:Reason|‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•|‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏)\s*[:=]\s*(.*)/i);
                const newLocation = extractFallback(/(?:Location|‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà|‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á|Site|‡πÑ‡∏ã‡∏ï‡πå)\s*[:=]\s*(.*)/i);
                const newDate = extractFallback(/(?:Date|‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà|‡∏ß‡∏±‡∏ô)\s*[:=]\s*(.*)/i);
                const newTime = extractFallback(/(?:Time|‡πÄ‡∏ß‡∏•‡∏≤|‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤)\s*[:=]\s*(.*)/i);
                
                const finalInterruptionId = newId || ('AUTO-' + Math.floor(Math.random() * 1000000));
                const finalInterruption = newInterruption || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô';

                const resRegex = /(?:‡πÄ‡∏à‡πâ‡∏≤\s*‡∏´‡∏ô‡πâ‡∏≤\s*‡∏ó‡∏µ‡πà.*|‡∏ú‡∏π‡πâ\s*‡∏õ[‡∏è‡∏é]‡∏¥‡∏ö‡∏±‡∏ï‡∏¥\s*‡∏á‡∏≤‡∏ô|NSB\s*Responsible|‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô)\s*[:=]\s*([\s\S]*)/i;
                const resMatch = cleanText.match(resRegex);
                let responsible = '';
                if (resMatch && resMatch[1]) {
                const lines = resMatch[1].split('\n');
                const validLines = [];
                for (let line of lines) {
                    const t = line.trim();
                    if (t.includes(':') && validLines.length > 0) break;
                    if (t) validLines.push(t);
                }
                responsible = validLines.join(', ').replace(/,,+/g, ',').replace(/,\s*,/g, ',');
                }

                const standardTime = newTime.replace(/\./g, ':').toLowerCase();

                let duration = '3';
                if (standardTime.includes('22:00') && standardTime.includes('06:00')) duration = '8';
                else if (standardTime.includes('22:00') && standardTime.includes('05:00')) duration = '7';
                else if (standardTime.includes('18:00') && standardTime.includes('21:00')) duration = '3';
                else if (standardTime.includes('21:00') && standardTime.includes('05:00')) duration = '8';
                else if (standardTime.includes(' ‚Äì ') || standardTime.includes(' - ') || standardTime.includes('-') || standardTime.includes('‡∏ñ‡∏∂‡∏á')) {
                    const separator = standardTime.includes('‡∏ñ‡∏∂‡∏á') ? '‡∏ñ‡∏∂‡∏á' : (standardTime.includes('‚Äì') ? '‚Äì' : '-');
                    const parts = standardTime.split(separator);
                    if (parts.length >= 2) {
                        const startMatch = parts[0].match(/(\d{1,2}):(\d{2})/);
                        const endMatch = parts[1].match(/(\d{1,2}):(\d{2})/);
                        
                        if (startMatch && endMatch) {
                            const startTotal = parseInt(startMatch[1], 10) + (parseInt(startMatch[2], 10) / 60);
                            let endTotal = parseInt(endMatch[1], 10) + (parseInt(endMatch[2], 10) / 60);
                            
                            if (!isNaN(startTotal) && !isNaN(endTotal)) {
                            if (endTotal <= startTotal) endTotal += 24; 
                            let diff = endTotal - startTotal;
                            duration = diff % 1 === 0 ? diff.toString() : diff.toFixed(1);
                            }
                        }
                    }
                }

                setFormData({
                ...formData,
                interruption: finalInterruption,
                interruptionId: finalInterruptionId,
                reason: newReason || formData.reason,
                location: newLocation || formData.location,
                date: newDate || formData.date,
                time: newTime || formData.time,
                responsible: responsible || formData.responsible,
                duration: duration,
                jobType: calculateJobType(duration)
                });
                
                setIsExtracting(false);
                setIsSmartPaste(false);
                setRawText('');
            };

            const handleImageUpload = async (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                if (GAS_WEBHOOK_URL === '‡πÉ‡∏™‡πà_URL_WEB_APP_‡∏Ç‡∏≠‡∏á_GAS_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà') {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥ Web App URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 26 ‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
                    return;
                }

                setUploadingState(prev => ({ ...prev, [type]: true }));

                try {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = async () => {
                            const MAX_WIDTH = 800;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > MAX_WIDTH) {
                                height = height * (MAX_WIDTH / width);
                                width = MAX_WIDTH;
                            }
                            
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const base64String = canvas.toDataURL('image/jpeg', 0.7);
                            const base64Data = base64String.split(',')[1];
                            
                            try {
                                // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏•‡∏ö‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å (CORS)
                                const response = await fetch(GAS_WEBHOOK_URL, {
                                    method: 'POST',
                                    redirect: 'follow', // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏° Redirect ‡∏Ç‡∏≠‡∏á Google
                                    body: JSON.stringify({
                                        action: 'upload_image',
                                        filename: `OT_${type}_${Date.now()}.jpg`,
                                        mimeType: 'image/jpeg',
                                        base64: base64Data
                                    }),
                                    headers: { 
                                        'Content-Type': 'text/plain;charset=utf-8' // ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ text/plain ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î Preflight CORS
                                    }
                                });
                                
                                const textResponse = await response.text();
                                
                                if (textResponse.trim() === "OK") {
                                     throw new Error("‡∏£‡∏∞‡∏ö‡∏ö‡∏ù‡∏±‡πà‡∏á Google Apps Script ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (OK) ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô doPost ‡πÉ‡∏ô GAS");
                                }
                                
                                let result;
                                try {
                                    result = JSON.parse(textResponse);
                                } catch (parseError) {
                                    console.error("Non-JSON response from GAS:", textResponse);
                                    throw new Error("‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ú‡∏¥‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Who has access ‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GAS ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Anyone)");
                                }
                                
                                if (result && result.success) {
                                    setFormData(prev => ({ ...prev, [type]: result.url }));
                                } else {
                                    alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (result?.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
                                }
                            } catch (err) {
                                console.error('Upload API Error:', err);
                                // üåü ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Failed to fetch ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î
                                if (err.message.includes('Failed to fetch')) {
                                    alert(`üö® ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å (Failed to fetch)\n\n‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ó‡∏≥‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö Google Apps Script):\n1. ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô '‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' (Deploy)\n2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' (Manage deployments)\n3. ‡∏Å‡∏î‡∏£‡∏π‡∏õ ‚úèÔ∏è ‡∏î‡∏¥‡∏ô‡∏™‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç\n4. ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î! ‡∏ï‡∏£‡∏á '‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Who has access)' ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô "‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (Anyone)" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô\n5. ‡∏Å‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ URL (‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec) ‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö`);
                                } else {
                                    alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ:\n${err.message}`);
                                }
                            } finally {
                                setUploadingState(prev => ({ ...prev, [type]: false }));
                            }
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error(error);
                    setUploadingState(prev => ({ ...prev, [type]: false }));
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div>
                <div className="relative bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] border border-slate-200">
                    <div className="p-6 border-b border-slate-100 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <h3 className="text-xl font-bold text-slate-800">{initialData ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô OT' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô OT'}</h3>
                        {!initialData && (
                        <button 
                            type="button"
                            onClick={() => setIsSmartPaste(!isSmartPaste)}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${
                            isSmartPaste ? 'bg-orange-500 text-white border-orange-500 shadow-md shadow-orange-500/20' : 'bg-orange-50 text-orange-600 border-orange-100 hover:bg-orange-100'
                            }`}
                        >
                            {isSmartPaste ? <X size={14} /> : <Sparkles size={14} />}
                            {isSmartPaste ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Paste' : 'Smart Paste'}
                        </button>
                        )}
                    </div>
                    <button onClick={onClose} className="p-2 text-slate-400 hover:text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">
                        <X size={20} />
                    </button>
                    </div>
                    
                    <form onSubmit={handleSubmit} className="p-6 overflow-y-auto space-y-6">
                    {isSmartPaste ? (
                        <div className="space-y-4 animate-in fade-in slide-in-from-top-2 duration-300">
                        <div className="bg-orange-50 border border-orange-200 p-4 rounded-xl flex items-start gap-3">
                            <ClipboardPaste className="text-orange-500 shrink-0 mt-1" size={20} />
                            <div className="text-sm text-orange-800">
                            <p className="font-bold">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï OT</p>
                            <p className="opacity-80 mt-1">‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                            </div>
                        </div>
                        <textarea 
                            rows="8"
                            autoFocus
                            disabled={isExtracting}
                            placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                            className={`w-full bg-slate-50 border-2 rounded-2xl px-4 py-4 text-slate-700 text-sm focus:border-orange-500 focus:bg-white outline-none transition-all ${isExtracting ? 'opacity-50 border-slate-200' : 'border-slate-200'}`}
                            value={rawText}
                            onChange={e => setRawText(e.target.value)}
                        />
                        <button 
                            type="button"
                            disabled={isExtracting}
                            onClick={handleSmartPaste}
                            className="w-full bg-orange-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-orange-500/30 hover:bg-orange-600 transition-all flex items-center justify-center gap-2 disabled:bg-slate-300 disabled:shadow-none"
                        >
                            {isExtracting ? (
                            <>
                                <Loader2 size={18} className="animate-spin" /> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
                            </>
                            ) : (
                            <>
                                <Sparkles size={18} /> ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                            </>
                            )}
                        </button>
                        </div>
                    ) : (
                        <>
                        <div className="bg-orange-50 border border-orange-100 p-4 rounded-2xl flex items-center justify-between shadow-sm">
                            <div>
                                <label className="text-[10px] font-black text-orange-500 uppercase tracking-widest">Auto-detected JOB Type</label>
                                <div className="text-lg font-black text-slate-800">{formData.jobType}</div>
                            </div>
                            <div className="bg-white p-2 rounded-xl shadow-sm border border-orange-100 flex flex-col items-center min-w-[80px]">
                                <span className="text-[10px] text-slate-400 font-bold">HOURS</span>
                                <input 
                                    type="number"
                                    step="0.5"
                                    className="w-full text-center text-xl font-black text-orange-600 bg-transparent outline-none"
                                    value={formData.duration}
                                    onChange={e => setFormData({...formData, duration: e.target.value})}
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-1.5">
                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Interruption ID</label>
                            <input 
                                type="text"
                                placeholder="INT2602-00027"
                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors font-medium"
                                value={formData.interruptionId}
                                onChange={e => setFormData({...formData, interruptionId: e.target.value})}
                            />
                            </div>
                            <div className="space-y-1.5">
                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Time (‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô)</label>
                            <input 
                                type="text"
                                placeholder="22:00 ‚Äì 06:00"
                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors font-medium"
                                value={formData.time}
                                onChange={e => setFormData({...formData, time: e.target.value})}
                            />
                            </div>
                        </div>

                        <div className="space-y-1.5">
                            <label className="text-xs font-bold text-orange-600 uppercase tracking-wider">Interruption (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô)</label>
                            <textarea 
                            required
                            rows="2"
                            placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô..."
                            className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors font-medium"
                            value={formData.interruption}
                            onChange={e => setFormData({...formData, interruption: e.target.value})}
                            />
                        </div>

                        <div className="space-y-1.5">
                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">Reason (‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)</label>
                            <input 
                            type="text"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏∑‡πâ‡∏≠‡∏ñ‡∏≠‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå, ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≤‡∏¢..."
                            className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors font-medium"
                            value={formData.reason}
                            onChange={e => setFormData({...formData, reason: e.target.value})}
                            />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-1.5">
                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                                <MapPin size={12} className="text-orange-500" /> Location (‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà)
                            </label>
                            <input 
                                required
                                type="text"
                                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..."
                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors font-medium"
                                value={formData.location}
                                onChange={e => setFormData({...formData, location: e.target.value})}
                            />
                            </div>
                            <div className="space-y-1.5">
                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                                <Calendar size={12} className="text-orange-500" /> Date (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)
                            </label>
                            <input 
                                required
                                type="text"
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô Feb 24, 2026"
                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors font-medium"
                                value={formData.date}
                                onChange={e => setFormData({...formData, date: e.target.value})}
                            />
                            </div>
                        </div>

                        <div className="space-y-1.5">
                            <label className="text-xs font-bold text-slate-500 uppercase flex items-center gap-1">
                            <Users size={12} className="text-orange-500" /> ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
                            </label>
                            <input 
                            required
                            type="text"
                            placeholder="‡πÄ‡∏ä‡πà‡∏ô Arttapon.J"
                            className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-700 focus:bg-white focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-colors font-medium"
                            value={formData.responsible}
                            onChange={e => setFormData({...formData, responsible: e.target.value})}
                            />
                            {loggedInUser?.role !== 'admin' && (
                            <p className="text-[10px] text-orange-500 font-bold ml-1">
                                * ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏¥‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                            </p>
                            )}
                        </div>

                        <div className="grid grid-cols-2 gap-4 pt-2">
                            <div className="relative border-2 border-dashed border-slate-200 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 text-slate-400 hover:border-orange-400 hover:text-orange-500 hover:bg-orange-50/50 transition-all bg-slate-50 overflow-hidden h-32 group cursor-pointer">
                            <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'beforeImage')} disabled={uploadingState.beforeImage} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10 disabled:cursor-not-allowed" />
                            {uploadingState.beforeImage ? (
                                <div className="absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-orange-500 z-20">
                                    <Loader2 className="animate-spin mb-2" size={24} />
                                    <span className="text-[10px] font-bold uppercase tracking-widest">Uploading...</span>
                                </div>
                            ) : formData.beforeImage ? (
                                <>
                                <img src={formData.beforeImage} alt="Before" className="absolute inset-0 w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" />
                                <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center text-white z-0">
                                    <Upload size={20} className="mb-1" />
                                    <span className="text-[10px] font-bold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</span>
                                </div>
                                </>
                            ) : (
                                <>
                                <Upload size={24} />
                                <span className="text-[10px] font-bold uppercase tracking-widest text-center">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î<br/>‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥</span>
                                </>
                            )}
                            </div>

                            <div className="relative border-2 border-dashed border-slate-200 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 text-slate-400 hover:border-orange-400 hover:text-orange-500 hover:bg-orange-50/50 transition-all bg-slate-50 overflow-hidden h-32 group cursor-pointer">
                            <input type="file" accept="image/*" onChange={(e) => handleImageUpload(e, 'afterImage')} disabled={uploadingState.afterImage} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10 disabled:cursor-not-allowed" />
                            {uploadingState.afterImage ? (
                                <div className="absolute inset-0 bg-white/90 flex flex-col items-center justify-center text-orange-500 z-20">
                                    <Loader2 className="animate-spin mb-2" size={24} />
                                    <span className="text-[10px] font-bold uppercase tracking-widest">Uploading...</span>
                                </div>
                            ) : formData.afterImage ? (
                                <>
                                <img src={formData.afterImage} alt="After" className="absolute inset-0 w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-opacity" />
                                <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center text-white z-0">
                                    <Upload size={20} className="mb-1" />
                                    <span className="text-[10px] font-bold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</span>
                                </div>
                                </>
                            ) : (
                                <>
                                <Upload size={24} />
                                <span className="text-[10px] font-bold uppercase tracking-widest text-center">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î<br/>‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>
                                </>
                            )}
                            </div>
                        </div>
                        </>
                    )}
                    </form>

                    <div className="p-6 border-t border-slate-100 flex gap-3 bg-slate-50 rounded-b-2xl">
                    <button 
                        type="button"
                        onClick={onClose}
                        className="flex-1 px-4 py-3 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-white hover:text-slate-800 transition-colors"
                    >
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    {!isSmartPaste && (
                        <button 
                        onClick={handleSubmit}
                        className="flex-1 px-4 py-3 bg-orange-500 text-white rounded-xl font-bold hover:bg-orange-600 shadow-lg shadow-orange-500/30 transition-all"
                        >
                        {initialData ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                        </button>
                    )}
                    </div>
                </div>
                </div>
            );
        }

        // --- Render React App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
